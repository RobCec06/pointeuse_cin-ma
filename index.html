<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pointeuse Cin√©ma</title>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=DIN+Condensed&display=swap');

body {
  font-family: 'DIN Condensed', sans-serif;
  background: url('base_plein_air_evenement.jpeg') no-repeat center center fixed;
  background-size: cover;
  background-color: #000;
  color: #f0f0f0;
  margin: 0;
  padding: 2rem;
  text-align: center;
}

#mainContent {
  display: none;
}

.logo {
  max-width: 200px;
  height: auto;
  display: block;
  margin: 0 auto 1rem auto;
}

h1 {
  margin-bottom: 1.5rem;
  font-size: 2.4rem;
  color: #ffd700;
  text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
  letter-spacing: 1px;
}

.profile {
  margin: 1rem auto;
  background-color: rgba(20, 20, 20, 0.75);
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 0 12px rgba(255, 215, 0, 0.2);
  max-width: 500px;
  transition: transform 0.2s ease;
}

.profile:hover {
  transform: scale(1.02);
}

.profile h2 {
  margin-bottom: 1rem;
  font-weight: 600;
  font-size: 1.5rem;
  color: #ffcc00;
  text-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
}

button {
  margin: 0.4rem;
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  border: 1px solid #ffcc00;
  border-radius: 8px;
  cursor: pointer;
  background-color: #111;
  color: #fff;
  transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
}

button:hover:not(:disabled) {
  background-color: #222;
  transform: scale(1.05);
  box-shadow: 0 0 10px #ffcc00;
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.reset-btn {
  background-color: #8b0000;
  border: none;
  margin-top: 1.5rem;
  color: #fff;
}

#log {
  margin-top: 2rem;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  text-align: left;
  background-color: rgba(0, 0, 0, 0.8);
  padding: 1.2rem;
  border-radius: 16px;
  box-shadow: 0 0 10px #333;
  font-family: monospace;
  white-space: pre-wrap;
}

.entry {
  background-color: #1b1b1b;
  padding: 0.6rem;
  margin: 0.5rem 0;
  border-radius: 6px;
  color: #f0f0f0;
  border-left: 4px solid #ffcc00;
}

.arrival {
  color: #90ee90;
  font-weight: bold;
}

.departure {
  color: #ff7f50;
  font-weight: bold;
}

@media (max-width: 768px) {
  body {
    padding: 1rem;
  }

  h1 {
    font-size: 1.8rem;
  }

  button {
    width: 100%;
    margin: 0.3rem 0;
  }

  .profile {
    padding: 1rem;
  }

  #log {
    padding: 1rem;
  }
}

@media (max-width: 480px) {
  .logo {
    max-width: 140px;
  }

  h1 {
    font-size: 1.4rem;
  }
}

  </style>
</head>
<body>
<div id="loginPage">
  <h2>Connexion</h2>
  <input type="text" id="username" placeholder="Nom d'utilisateur"><br><br>
  <input type="password" id="password" placeholder="Mot de passe"><br><br>
  <button onclick="login()">Se connecter</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="mainContent">
  <img src="https://cinemadebeaulieu.com/wp-content/uploads/2016/06/logo_cinmadebeaulieu.png" alt="Logo Cin√©ma de Beaulieu" class="logo">
  <h1>Pointeuse - Cin√©ma üé®</h1>

  <div class="profile">
    <h2>üë®‚Äçüíº Robin</h2>
    <button id="arrivee-Robin" onclick="pointer('Robin', 'arriv√©e')">üì• Arriv√©e</button>
    <button id="depart-Robin" onclick="pointer('Robin', 'd√©part')">üì§ D√©part</button>
  </div>

  <div class="profile">
    <h2>üë©‚Äçüíº Victoria</h2>
    <button id="arrivee-Victoria" onclick="pointer('Victoria', 'arriv√©e')">üì• Arriv√©e</button>
    <button id="depart-Victoria" onclick="pointer('Victoria', 'd√©part')">üì§ D√©part</button>
  </div>

  <button class="reset-btn" onclick="resetLog()">üóëÔ∏è R√©initialiser tout</button>
  <button onclick="exportToPDF()">üìÑ Exporter en PDF</button>
  <button onclick="exportToExcel()">üìä Exporter en Excel</button>

  <div id="log"></div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js';
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBN6-Zbl4LSeCj0O4HOJIcRKq7ZAv41o6E",
    authDomain: "pointeuse-cinema-beaulieu.firebaseapp.com",
    projectId: "pointeuse-cinema-beaulieu",
    storageBucket: "pointeuse-cinema-beaulieu.appspot.com",
    messagingSenderId: "1042682924564",
    appId: "1:1042682924564:web:9e989e2331373e35e22101",
    measurementId: "G-7EPLLYK4KQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const userStates = {};

  window.pointer = async function(nom, type) {
    const now = new Date();
    const entry = {
      nom,
      type,
      time: now.toLocaleTimeString('fr-FR'),
      date: now.toLocaleDateString('fr-FR'),
      timestamp: now.getTime()
    };

    try {
      await addDoc(collection(db, "pointages"), entry);
      userStates[nom] = type;
      toggleButtons(nom, type);
      window.displayLog();
    } catch (e) {
      console.error("Erreur Firebase:", e);
    }
  }

  function toggleButtons(nom, type) {
    const arriveeBtn = document.getElementById(`arrivee-${nom}`);
    const departBtn = document.getElementById(`depart-${nom}`);

    if (arriveeBtn && departBtn) {
      if (type === 'arriv√©e') {
        arriveeBtn.disabled = true;
        departBtn.disabled = false;
      } else {
        arriveeBtn.disabled = false;
        departBtn.disabled = true;
      }
    }
  }

  window.displayLog = async function() {
    const logContainer = document.getElementById("log");
    logContainer.innerHTML = "Chargement...";

    try {
      const q = query(collection(db, "pointages"), orderBy("timestamp", "asc"));
      const querySnapshot = await getDocs(q);

      logContainer.innerHTML = "";
      const entries = [];
      querySnapshot.forEach(doc => entries.push(doc.data()));

      const grouped = {};
      entries.forEach(entry => {
        const key = `${entry.nom}-${entry.date}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(entry);
      });

      const orderedKeys = Object.keys(grouped).sort((a, b) => {
        const ta = grouped[a][0].timestamp;
        const tb = grouped[b][0].timestamp;
        return tb - ta;
      });

      orderedKeys.forEach(key => {
        const logs = grouped[key];
        for (let i = 0; i < logs.length - 1; i++) {
          const entry = logs[i];
          const next = logs[i + 1];

          if (entry.type === 'arriv√©e' && next.type === 'd√©part') {
            const start = new Date(entry.timestamp);
            const end = new Date(next.timestamp);
            const diffMs = end - start;
            const diffH = Math.floor(diffMs / (1000 * 60 * 60));
            const diffM = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            const div = document.createElement("div");
            div.className = "entry";
            div.textContent = `${entry.date} - ${entry.time} ‚Üí ${next.time} | ${entry.nom} | ${diffH}h ${diffM}`;
            logContainer.appendChild(div);
          }
        }
      });
    } catch (e) {
      logContainer.innerHTML = "Erreur de chargement.";
      console.error("Erreur lors de l'affichage du log:", e);
    }
  }

  window.resetLog = function() {
    if (confirm("Voulez-vous vraiment effacer l'historique affich√© sur le site ?")) {
      const logContainer = document.getElementById("log");
      logContainer.innerHTML = "";
    }
  }

 window.exportToPDF = function () {
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  script.onload = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(13); // üëà r√©duction de la taille du texte PDF
    const entries = document.querySelectorAll('.entry');
    let y = 10;
    entries.forEach(entry => {
      doc.text(entry.textContent, 10, y);
      y += 6; // r√©duit aussi l'espacement pour s'adapter √† la taille
    });
    doc.save("pointages.pdf");
  };
  document.body.appendChild(script);
};

  window.exportToExcel = function () {
    let csvContent = "data:text/csv;charset=utf-8,Date,Heure d√©but,Heure fin,Nom,Dur√©e\n";
    const entries = document.querySelectorAll('.entry');
    entries.forEach(entry => {
      const text = entry.textContent;
const match = text.match(/(\d{2}\/\d{2}\/\d{4}) - (\d{2}:\d{2}:\d{2}) ‚Üí (\d{2}:\d{2}:\d{2}) \| (.+?) \| (\d+)h (\d+)/);
      if (match) {
        const [, date, start, end, name, h, m] = match;
        csvContent += `${date},${start},${end},${name},${h}h ${m}min\n`;
      }
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "pointages.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  window.login = function() {
    const username = document.getElementById('username').value.trim().toLowerCase();
    const password = document.getElementById('password').value.trim();
    const users = { "admin": "cinema123" };

    if (users[username] === password) {
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      window.displayLog();
    } else {
      document.getElementById("loginError").textContent = "Identifiants incorrects.";
    }
  }

  window.onload = function () {
    document.getElementById("loginPage").style.display = "block";
    document.getElementById("mainContent").style.display = "none";
  }
</script>
</body>
</html>